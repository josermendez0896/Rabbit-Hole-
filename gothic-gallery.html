<!DOCTYPE html>
<html lang="es" class="dark theme-red">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://fonts.gstatic.com https://placehold.co data: blob:;">
    <title>Ars Gothica 10.6 (Estable Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        const themes = {
            red: { bg: '#030000', panel: '#0a0404', input: '#140808', text: '#d4cba8', gold: '#b89b5e', accent: '#8a1c1c', primary: '#dc143c', primary_shadow: 'rgba(220, 20, 60, 0.4)' },
            blue: { bg: '#00030a', panel: '#04040a', input: '#080814', text: '#c8d4e8', gold: '#9bb8e3', accent: '#1c1c8a', primary: '#3366ff', primary_shadow: 'rgba(51, 102, 255, 0.4)' },
            green: { bg: '#030500', panel: '#040a04', input: '#081408', text: '#c8e8d4', gold: '#9be3b8', accent: '#1c8a1c', primary: '#10b981', primary_shadow: 'rgba(16, 185, 129, 0.4)' }
        };
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { gothic: ({ opacityValue }) => { const t = themes[document.documentElement.getAttribute('data-theme') || 'red']; return { bg: t.bg, panel: t.panel, input: t.input, text: t.text, gold: t.gold, accent: t.accent, primary: t.primary, } } }, fontFamily: { heading: ['Cinzel Decorative', 'serif'], body: ['Crimson Text', 'serif'] }, boxShadow: { 'gothic-glow': ({ opacityValue }) => { const t = themes[document.documentElement.getAttribute('data-theme') || 'red']; return `0 0 20px ${t.primary_shadow}`; }, 'gothic-deep': '0 10px 30px -5px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(0,0,0,0.9)', } } } }
    </script>
    <style>
        /* SCROLLBAR G√ìTICO */
        ::-webkit-scrollbar { width: 12px; background-color: #050000; }
        ::-webkit-scrollbar-track { background: #0a0000; border-left: 1px solid #330000; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #300000 0%, #8a1c1c 50%, #300000 100%); border: 1px solid #ff0000; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #dc143c; box-shadow: 0 0 10px #dc143c; }

        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&display=swap');
        .theme-red { --color-primary: 220, 20, 60; --color-accent: 138, 28, 28; --color-gold: 184, 155, 94; }
        .theme-blue { --color-primary: 51, 102, 255; --color-accent: 28, 28, 138; --color-gold: 155, 184, 227; }
        .theme-green { --color-primary: 16, 185, 129; --color-accent: 28, 138, 28; --color-gold: 155, 227, 184; }
        
        body { font-family: 'Crimson Text', serif; background-color: theme('colors.gothic.bg'); color: theme('colors.gothic.text'); min-height: 100vh; overflow-x: hidden; }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(to bottom, rgba(var(--color-accent),0.2) 0%, rgba(var(--color-accent),0.05) 50%, rgba(var(--color-accent),0.0) 100%), url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='rgb(var(--color-accent) / 0.15)' %3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); background-attachment: fixed; z-index: -2; }
        #particlesCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; opacity: 0.6; }

        h1, h2, h3, .gothic-heading { font-family: 'Cinzel Decorative', serif; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        .gothic-panel { background-color: theme('colors.gothic.panel'); border: 2px solid rgb(var(--color-accent) / 0.7); box-shadow: theme('boxShadow.gothic-deep'); }
        .gothic-input { border: 1px solid rgb(var(--color-accent) / 0.5) !important; color-scheme: dark; }
        .gothic-input:focus { border-color: rgb(var(--color-primary)) !important; box-shadow: 0 0 10px rgb(var(--color-primary) / 0.2), inset 0 2px 5px rgba(0,0,0,0.5) !important; }
        .gothic-tab-active { border-color: rgb(var(--color-primary)) !important; }
        .gothic-btn-primary { background: linear-gradient(to bottom, rgb(var(--color-accent) / 0.8) 0%, theme('colors.gothic.bg') 100%); border-color: rgb(var(--color-accent) / 0.8); color: theme('colors.gothic.text'); transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.6); }
        .gothic-btn-primary:hover { background: linear-gradient(to bottom, rgb(var(--color-primary) / 0.8) 0%, rgb(var(--color-primary) / 0.2) 100%); border-color: rgb(var(--color-primary) / 0.9); color: white; box-shadow: theme('boxShadow.gothic-glow'); }
        .theme-red-btn { background-color: rgb(220, 20, 60); } .theme-blue-btn { background-color: rgb(51, 102, 255); } .theme-green-btn { background-color: rgb(16, 185, 129); }
        
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .gothic-toast { background-color: theme('colors.gothic.panel'); color: theme('colors.gothic.text'); padding: 15px 25px; border: 2px solid rgb(var(--color-primary)); box-shadow: 0 5px 20px rgba(0,0,0,0.5), 0 0 10px rgb(var(--color-primary) / 0.5); font-family: 'Cinzel Decorative', serif; animation: fadeInOut 5s forwards; min-width: 300px; text-align: right; position: relative; }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translateX(100%); } 10% { opacity: 1; transform: translateX(0); } 90% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; transform: translateX(100%); } }
        
        .masonry-item { break-inside: avoid; margin-bottom: 2rem; }
        .drag-active { border-color: rgb(var(--color-primary)) !important; background-color: rgba(var(--color-primary), 0.1) !important; transform: scale(1.02); }
        .visor-mode #creationSection, .visor-mode #filterSection, .visor-mode #mainHeader > div:last-child { display: none !important; }
        .visor-mode #mainHeader { border-bottom: none; justify-content: center; } .visor-mode #galleryContainer { margin-top: 4rem; }
        .select-checkbox { appearance: none; width: 1.5rem; height: 1.5rem; border: 2px solid rgb(var(--color-primary)); background: transparent; cursor: pointer; position: relative; }
        .select-checkbox:checked { background-color: rgb(var(--color-primary)); }
        .select-checkbox:checked::after { content: '‚úï'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1rem; font-weight: bold; }
        .sync-step { opacity: 0.5; transition: opacity 0.3s; pointer-events: none; }
        .sync-step.active-step { opacity: 1; pointer-events: auto; }
        
        /* LOCK SCREEN */
        #lockScreen { position: fixed; inset: 0; z-index: 2000; background-color: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s ease; }
        #lockScreen.unlocked { opacity: 0; pointer-events: none; }

        /* EDITOR */
        .editor-btn { background: rgba(0,0,0,0.6); border: 1px solid theme('colors.gothic.accent'); color: theme('colors.gothic.text'); padding: 5px 10px; font-size: 0.8em; uppercase; cursor: pointer; }
        .editor-btn:hover { background: theme('colors.gothic.primary'); color: white; }
    </style>
</head>
<body class="overflow-x-hidden">
    
    <canvas id="particlesCanvas"></canvas>
    
    <div id="lockScreen">
        <h1 class="text-6xl font-black text-gothic-primary uppercase tracking-[0.2em] font-heading drop-shadow-[0_0_20px_rgba(220,20,60,0.8)] mb-8 animate-pulse">Ars Gothica X</h1>
        <div class="gothic-panel p-10 max-w-md w-full text-center relative">
            <p class="text-gothic-gold mb-6 font-heading uppercase tracking-widest" id="lockMessage">El Sello Herm√©tico est√° cerrado</p>
            <input type="password" id="vaultPassword" class="gothic-input w-full p-4 text-center text-xl mb-6 rounded-sm" placeholder="Contrase√±a Maestra">
            <button onclick="unlockVault()" class="w-full gothic-btn-primary py-4 uppercase font-bold tracking-[0.2em]">Romper el Sello</button>
            <p class="text-xs text-gray-600 mt-4">Toda la informaci√≥n ser√° cifrada (AES-GCM).</p>
        </div>
    </div>

    <div id="toastContainer"></div>
    <div id="autoSaveNotification">‚ú† Cifra Guardada ‚ú†</div>

    <div class="container mx-auto p-6 max-w-6xl relative z-10 hidden" id="mainApp">
        
        <header id="mainHeader" class="flex flex-col md:flex-row justify-between items-end py-10 mb-8 border-b-2 border-gothic-accent/60 gap-4 relative">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-3/4 h-full bg-gothic-accent/10 blur-3xl -z-10 pointer-events-none"></div>
            <div>
                <h1 class="text-5xl md:text-6xl font-black text-gothic-text uppercase tracking-widest font-heading drop-shadow-lg">Ars <span class="text-gothic-primary text-shadow-glow">Gothica</span></h1>
                <p class="text-gothic-primary/70 italic text-lg mt-2 font-heading tracking-wider">La Obra Maestra (v10.6)</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                 <button onclick="lockVault()" class="p-3 border-2 border-gothic-primary bg-gothic-panel text-gothic-primary rounded-full hover:bg-red-700 hover:text-white transition-all shadow-gothic-glow" title="Cerrar B√≥veda (P√°nico)">üîí</button>
                 
                 <button onclick="toggleAudio()" id="audioBtn" class="p-3 border-2 gothic-btn-primary rounded-full" title="Sinfon√≠a Nocturna">üîá</button>
                <div class="flex gap-2">
                    <button onclick="toggleTheme('red')" class="p-3 border-2 gothic-btn-primary rounded-full theme-red-btn" title="Tema Rojo"></button>
                    <button onclick="toggleTheme('blue')" class="p-3 border-2 gothic-btn-primary rounded-full theme-blue-btn" title="Tema Azul"></button>
                    <button onclick="toggleTheme('green')" class="p-3 border-2 gothic-btn-primary rounded-full theme-green-btn" title="Tema Verde"></button>
                </div>
                 <button onclick="toggleVisorMode()" id="visorModeBtn" class="gothic-btn-primary text-sm px-4 py-2 uppercase font-bold tracking-[0.1em] font-heading whitespace-nowrap">Visor</button>
                 <button onclick="toggleSyncModal()" class="gothic-btn-primary text-sm px-4 py-2 uppercase font-bold tracking-[0.1em] font-heading whitespace-nowrap text-gothic-gold border-gothic-gold/50">Sincronizar</button>
                <label for="importFile" class="gothic-btn-primary text-sm px-4 py-2 uppercase font-bold tracking-[0.1em] font-heading cursor-pointer whitespace-nowrap">Importar<input type="file" id="importFile" accept=".json" onchange="importData(this)" /></label>
                <button onclick="exportData()" class="gothic-btn-primary text-sm px-4 py-2 uppercase font-bold tracking-[0.1em] font-heading whitespace-nowrap">Exportar</button>
            </div>
        </header>

        <div id="selectionBar" class="hidden bg-gothic-panel border-2 border-gothic-primary p-4 mb-6 flex justify-between items-center shadow-gothic-glow">
            <span class="text-gothic-text font-heading uppercase tracking-widest"><span id="selectedCount" class="text-gothic-primary font-bold">0</span> Seleccionados</span>
            <div class="flex gap-3"><button onclick="deleteSelected()" class="bg-red-900 text-white px-4 py-2 uppercase font-heading border border-red-600 hover:bg-red-700">Purgar</button><button onclick="toggleSelectMode()" class="gothic-btn-primary px-4 py-2 uppercase font-heading">Cancelar</button></div>
        </div>

        <div id="creationSection" class="gothic-panel rounded-sm overflow-hidden mb-16 relative">
             <div id="globalLoader" class="hidden absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                <div id="loaderContent" class="flex flex-col items-center"><div class="spinner mb-4"></div><p class="text-gothic-primary font-heading tracking-[0.3em] text-lg animate-pulse">Cifrando Reliquia...</p></div>
            </div>
            <div class="flex flex-col lg:flex-row">
                <div class="w-full lg:w-5/12 p-10 border-b-2 lg:border-b-0 lg:border-r-2 border-gothic-accent/40 relative">
                    <h2 id="formTitle" class="text-3xl font-bold mb-8 font-heading text-gothic-primary/90 border-b border-gothic-accent/30 pb-4 tracking-wider drop-shadow">Nuevo Artefacto</h2>
                    <input type="hidden" id="editItemId" value=""> 
                    <div class="space-y-6">
                        <div class="relative group"><label class="block text-xs font-bold text-gothic-gold uppercase mb-2 tracking-widest font-heading">T√≠tulo</label><input type="text" id="inputDescription" oninput="updatePreviewText(); autoSaveForm()" class="gothic-input w-full p-4 rounded-sm focus:outline-none transition text-lg placeholder-gothic-accent/30" placeholder="Ej. El C√≥dice Gigas" maxlength="100"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="relative group"><label class="block text-xs font-bold text-gothic-gold uppercase mb-2 tracking-widest font-heading">Clasificaci√≥n</label><input type="text" id="inputCategory" oninput="updatePreviewText(); autoSaveForm()" class="gothic-input w-full p-4 rounded-sm focus:outline-none transition text-sm placeholder-gothic-accent/30" placeholder="Ej. Tomos" maxlength="50"></div>
                            <div class="relative group"><label class="block text-xs font-bold text-gothic-gold uppercase mb-2 tracking-widest font-heading">Tags</label><input type="text" id="inputTags" oninput="updatePreviewText(); autoSaveForm()" class="gothic-input w-full p-4 rounded-sm focus:outline-none transition text-sm placeholder-gothic-accent/30" placeholder="#oscuro" maxlength="100"></div>
                        </div>
                        <div class="h-px bg-gothic-accent/60 my-4"></div>
                        <div>
                            <label class="block text-xs font-bold text-gothic-gold uppercase mb-2 tracking-widest font-heading">Reliquia Visual</label>
                            <div class="flex mb-4 border-b border-gothic-accent/60"><button onclick="selectSource('file')" id="tabFile" class="gothic-tab-active font-heading uppercase tracking-widest text-gothic-primary pb-2 px-4 border-b-2 border-gothic-primary transition-colors">Archivo</button><button onclick="selectSource('url')" id="tabUrl" class="text-sm font-heading text-gray-500 hover:text-gothic-primary pb-2 px-4 transition-colors">URL</button></div>
                            <div id="contentFile"><label id="dropZone" for="fileInput" class="cursor-pointer flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gothic-accent/60 hover:border-gothic-primary/80 hover:bg-black/40 rounded-sm bg-black/20 transition-all duration-300 group relative overflow-hidden"><div class="absolute inset-0 bg-gradient-to-t from-gothic-accent/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div><span class="text-5xl mb-4 text-gothic-accent group-hover:text-gothic-primary transition-colors duration-300 drop-shadow-lg">‚ú†</span><span class="text-sm font-bold text-gothic-primary/80 group-hover:text-gothic-text uppercase tracking-widest font-heading relative z-10">Arrastrar para Editar</span><span id="fileNameDisplay" class="text-xs text-gothic-gold/70 mt-3 font-mono relative z-10 border-t border-gothic-accent/30 pt-2">Se abrir√° el Taller</span></label><input id="fileInput" type="file" accept="image/*" onchange="handleFile(this.files)" /></div>
                            <div id="contentUrl" class="hidden"><input type="text" id="inputImageUrl" oninput="handleUrlInput(this); autoSaveForm()" placeholder="https://..." class="gothic-input w-full p-4 rounded-sm font-mono"></div>
                        </div>
                        <div class="flex gap-4"><button onclick="addItem()" id="actionButton" class="w-full py-5 gothic-btn-primary font-bold font-heading uppercase tracking-[0.25em] relative overflow-hidden group"><span class="relative z-10 drop-shadow">Consagrar (Cifrar)</span></button><button onclick="cancelEdit()" id="cancelEditBtn" class="hidden w-1/4 py-5 gothic-btn-primary border-gothic-accent/80 transition-all uppercase tracking-wider shadow-md">Cancelar</button></div>
                    </div>
                </div>
                <div class="w-full lg:w-7/12 bg-gothic-bg p-10 flex flex-col items-center justify-center relative overflow-hidden">
                    <div class="w-80 gothic-panel rounded-sm shadow-[0_20px_50px_rgba(0,0,0,0.9)] transform hover:scale-[1.02] transition-transform duration-500">
                        <div id="previewImage" class="w-full h-72 bg-black/80 bg-cover bg-center flex items-center justify-center border-b-2 border-gothic-accent/60 relative vignette-overlay overflow-hidden"><span class="text-gothic-accent/30 font-heading text-4xl tracking-widest font-black">VAC√çO</span></div>
                        <div class="p-6 text-center bg-gradient-to-b from-gothic-panel to-gothic-bg"><span id="previewCategory" class="block text-xs text-gothic-primary font-bold uppercase tracking-[0.2em] mb-2 font-heading">Clasificaci√≥n</span><h3 id="previewDescription" class="text-2xl text-gothic-text font-heading truncate tracking-wide">T√≠tulo</h3><div id="previewTags" class="mt-3 flex flex-wrap justify-center gap-1"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="filterSection" class="flex flex-col gap-4 md:flex-row justify-between items-center mb-8 border-b border-gothic-accent/30 pb-4">
            <h3 class="text-3xl font-heading text-gothic-text uppercase tracking-wider drop-shadow whitespace-nowrap">Inventario Cifrado</h3>
            <div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
                <button onclick="toggleLayout()" id="layoutToggleBtn" class="gothic-btn-primary text-sm p-3 uppercase font-bold tracking-[0.1em]"><svg id="gridIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg><svg id="listIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg></button>
                <button onclick="toggleSelectMode()" id="selectModeBtn" class="gothic-btn-primary text-sm p-3 uppercase font-bold tracking-[0.1em] text-gothic-text">Selecci√≥n</button>
                 <select id="filterField" onchange="loadGallery()" class="gothic-input w-full sm:w-36 p-3 rounded-sm text-sm"><option value="all">Todo</option><option value="description">T√≠tulo</option><option value="category">Clasificaci√≥n</option><option value="tags">Tags</option><option value="favorites">Consagrados</option></select>
                <div class="relative w-full sm:w-64"><input type="text" id="searchInput" oninput="loadGallery()" placeholder="Buscar (Desencriptado)..." class="gothic-input w-full p-3 rounded-sm text-sm placeholder-gothic-accent/50" maxlength="30" /></div>
                <select id="sortSelect" onchange="loadGallery()" class="gothic-input w-full sm:w-36 p-3 rounded-sm text-sm"><option value="timestamp_desc">Recientes</option><option value="timestamp_asc">Antiguos</option><option value="title_asc">A-Z</option><option value="title_desc">Z-A</option></select>
            </div>
            <div class="flex flex-col items-end"><span id="itemCount" class="text-sm text-gothic-primary uppercase tracking-[0.2em] font-bold font-heading bg-black/50 px-4 py-2 border border-gothic-accent/50 rounded-full shadow-gothic-glow whitespace-nowrap mb-1">0 Artefactos</span><span id="cryptSize" class="text-xs text-gothic-gold/60 font-mono">Peso: Calculando...</span></div>
        </div>
        <div id="galleryContainer" class="pb-10"></div>
        <div id="paginationControls" class="flex justify-center items-center gap-6 mt-8 mb-20 hidden"><button id="prevPageBtn" onclick="changePage(-1)" class="gothic-btn-primary text-sm px-6 py-2 uppercase shadow-gothic-glow disabled:opacity-30">Anterior</button><span id="pageInfo" class="text-lg text-gothic-gold font-heading tracking-wider">P√°gina 1</span><button id="nextPageBtn" onclick="changePage(1)" class="gothic-btn-primary text-sm px-6 py-2 uppercase shadow-gothic-glow disabled:opacity-30">Siguiente</button></div>
    </div>

    <div id="editorModal" class="hidden fixed inset-0 z-[70] bg-black/98 flex flex-col items-center justify-center p-4">
        <h2 class="text-3xl font-heading text-gothic-primary mb-4">Taller del Alquimista</h2>
        <div class="relative max-w-4xl max-h-[70vh] border-2 border-gothic-accent/50 p-1">
            <canvas id="editorCanvas" class="max-w-full max-h-full"></canvas>
        </div>
        <div class="flex gap-4 mt-6 flex-wrap justify-center">
            <button onclick="editorAction('rotate')" class="editor-btn">‚Üª Rotar 90¬∞</button>
            <button onclick="editorAction('grayscale')" class="editor-btn">Filtro: Ceniza</button>
            <button onclick="editorAction('sepia')" class="editor-btn">Filtro: Pergamino</button>
            <button onclick="editorAction('invert')" class="editor-btn">Filtro: Espectro</button>
            <button onclick="editorAction('reset')" class="editor-btn bg-red-900">Restaurar Original</button>
        </div>
        <div class="flex gap-4 mt-8 w-full max-w-md">
            <button onclick="saveEditor()" class="flex-1 gothic-btn-primary py-3 uppercase font-bold">Aceptar Transformaci√≥n</button>
            <button onclick="closeEditor()" class="flex-1 border border-gothic-accent text-gothic-text py-3 uppercase">Descartar</button>
        </div>
    </div>

    <div id="imageModal" class="hidden fixed inset-0 z-50 bg-gothic-bg/98 backdrop-blur-md flex flex-col items-center justify-center p-4" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-gothic-primary hover:text-gothic-text z-[60] p-3 bg-black/60 rounded-full border-2 border-gothic-accent/80 hover:border-gothic-primary transition-all duration-300 hover:rotate-90 shadow-gothic-glow"><svg class="w-8 h-8 drop-shadow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        <div class="relative w-full h-full flex flex-col items-center justify-center modal-print-border" onclick="event.stopPropagation()">
            <div class="flex-1 w-full flex items-center justify-center min-h-0 p-4 md:p-8 relative modal-enter"><img id="modalImg" src="" class="relative z-10 max-w-full max-h-full object-contain shadow-[0_0_100px_rgba(var(--color-accent),0.5)] border-4 border-gothic-accent/50 rounded-sm vignette-overlay"></div>
            <div class="w-full max-w-3xl text-center mt-2 mb-4 bg-black/70 p-6 border-t-2 border-gothic-accent/50 relative backdrop-blur-md modal-enter"><h3 id="modalTitle" class="text-3xl md:text-4xl font-heading text-gothic-primary tracking-[0.1em] drop-shadow uppercase"></h3><p id="modalCategory" class="text-base text-gothic-gold uppercase tracking-[0.25em] font-heading font-bold mt-2"></p><div id="modalTags" class="flex flex-wrap justify-center gap-2 mt-2"></div><div class="flex justify-center gap-4 mt-6"><a id="modalDownload" href="#" download class="gothic-btn-primary text-sm px-4 py-2 uppercase font-bold tracking-[0.1em] font-heading">Descargar</a></div></div>
        </div>
    </div>
    <div id="grimoireModal" class="hidden fixed inset-0 z-[80] bg-black/95 backdrop-blur-md flex items-center justify-center p-4" onclick="closeGrimoire()"><div class="gothic-panel w-full max-w-4xl p-10 relative overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()"><button class="absolute top-4 right-4 text-gothic-primary hover:text-white" onclick="closeGrimoire()">‚úï</button><h2 class="text-4xl font-heading text-gothic-primary uppercase tracking-widest mb-10 text-center border-b border-gothic-accent/50 pb-4">Grimorio de Estad√≠sticas</h2><div id="statsContainer" class="space-y-6"></div></div></div>
    <div id="confirmModal" class="hidden fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4"><div class="gothic-panel rounded-lg w-full max-w-lg p-8 relative shadow-[0_0_50px_rgba(var(--color-primary),0.5)] modal-enter" onclick="event.stopPropagation()"><h2 id="confirmTitle" class="text-4xl font-heading text-gothic-primary uppercase tracking-wider mb-4 drop-shadow">El Ritual</h2><p id="confirmMessage" class="text-gothic-text mb-6 text-lg font-body"></p><div class="h-px bg-gothic-accent/60 w-full my-4 opacity-40"></div><input type="text" id="confirmInput" class="gothic-input w-full p-3 rounded-sm text-center text-xl font-mono uppercase mb-6" placeholder="PURGAR"><div class="flex justify-between gap-4"><button onclick="executeGothicAction()" class="w-1/2 py-3 bg-gothic-primary hover:bg-gothic-primary/80 text-white font-bold uppercase font-heading border border-gothic-primary/50 shadow-gothic-glow" id="confirmBtn">Confirmar</button><button onclick="closeConfirmModal()" class="w-1/2 py-3 bg-gray-900 hover:bg-gray-800 text-gothic-text/80 font-bold uppercase font-heading border border-gray-700">Detener</button></div><input type="hidden" id="actionType" value=""><input type="hidden" id="actionId" value=""></div></div>
    
    <div id="syncModal" class="hidden fixed inset-0 z-[90] bg-black/95 backdrop-blur-md flex items-center justify-center p-4">
        <div class="gothic-panel w-full max-w-2xl p-8 relative flex flex-col gap-4">
            <button class="absolute top-4 right-4 text-gothic-primary hover:text-white" onclick="toggleSyncModal()">‚úï</button>
            <h2 class="text-3xl font-heading text-gothic-primary uppercase tracking-widest text-center mb-2">Puente de las Almas (P2P)</h2>
            <p class="text-center text-gothic-gold/60 text-sm mb-6 font-mono">Los datos se transfieren DESCIFRADOS y deben ser re-cifrados por el receptor.</p>
            <div class="flex border-b border-gothic-accent/30 mb-4">
                <button id="btnHost" onclick="setSyncRole('host')" class="flex-1 py-2 text-gothic-primary border-b-2 border-gothic-primary bg-gothic-accent/10 font-bold uppercase tracking-wider">Origen</button>
                <button id="btnGuest" onclick="setSyncRole('guest')" class="flex-1 py-2 text-gothic-text font-bold uppercase tracking-wider">Destino</button>
            </div>
            <div class="space-y-4">
                <div id="step1" class="sync-step active-step">
                    <label class="block text-xs text-gothic-gold mb-1 uppercase">1. C√≥digo Local</label>
                    <textarea id="localOffer" readonly class="gothic-input w-full h-24 p-2 text-xs font-mono text-gothic-primary/80 resize-none"></textarea>
                    <button onclick="copyToClipboard('localOffer')" class="mt-2 w-full border border-gothic-accent text-gothic-text hover:bg-gothic-accent/20 py-1 text-xs uppercase">Copiar</button>
                </div>
                <div id="step2" class="sync-step">
                    <label class="block text-xs text-gothic-gold mb-1 uppercase">2. C√≥digo Remoto</label>
                    <textarea id="remoteAnswer" class="gothic-input w-full h-24 p-2 text-xs font-mono text-gothic-text resize-none"></textarea>
                    <button id="btnConnect" onclick="finishHandshake()" class="mt-2 w-full gothic-btn-primary py-2 text-sm uppercase font-bold tracking-widest">Conectar</button>
                </div>
            </div>
            <div id="syncStatus" class="hidden flex flex-col items-center justify-center py-4 space-y-4 border-t border-gothic-accent/30 mt-4">
                <div class="w-4 h-4 bg-green-500 rounded-full shadow-[0_0_10px_#0f0] animate-pulse"></div>
                <p class="text-xl font-heading text-gothic-text">Conectado</p>
                <div id="hostActions" class="hidden w-full"><button onclick="startDataSync()" class="w-full gothic-btn-primary py-4 text-lg uppercase font-bold tracking-[0.2em] shadow-gothic-glow">Transmitir</button></div>
                <div id="guestActions" class="hidden w-full text-center"><p class="text-gothic-primary animate-pulse">Esperando...</p></div>
                <div id="syncProgress" class="w-full bg-black border border-gothic-accent h-4 mt-4 hidden"><div id="syncBar" class="h-full bg-gothic-primary w-0 transition-all duration-300"></div></div>
            </div>
            <button onclick="cancelSync()" class="mt-4 text-sm text-gothic-accent/80 hover:text-gothic-primary">Cancelar V√≠nculo y Cerrar</button>
        </div>
    </div>

    <script>
        // --- MANEJO DE ERRORES GLOBAL (V10.5) ---
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("ERROR CATASTR√ìFICO EN ARS GOTHICA:", message, error);
            showGothicToast("¬°Error Catastr√≥fico! La aplicaci√≥n fall√≥. Consulta la consola.", 'error');
            return true; 
        };

        const DB_NAME = 'GothicGalleryDB_X_Masterpiece'; const DB_VERSION = 1; const STORE_NAME = 'images'; const PURGE_KEYWORD = 'PURGAR'; const itemsPerPage = 12; 
        let db; let currentImageFile = null; let tempCompressedImage = null; let editorOriginalImage = null;
        let currentPage = 1; let currentFilteredItems = []; let imageSource = 'file'; let editingItemId = null; 
        let currentLayout = 'grid'; let selectMode = false; let selectedIds = new Set(); let slideshowInterval = null;
        
        // --- CORRECCI√ìN CR√çTICA DE REFERENCIA (V10.6) ---
        // Estas funciones deben estar definidas ANTES de ser llamadas en initDB().
        window.setupDragDrop = () => { /* Funci√≥n placeholder para evitar ReferenceError */ };
        window.autoSaveForm = () => { /* Funci√≥n placeholder para evitar ReferenceError */ };
        // --------------------------------------------------
        
        let vaultKey = null; 
        let dbEncrypted = true; 

        /* --- CRYPTO MODULE (A: SELLO HERM√âTICO) --- */
        const Crypto = {
            async deriveKey(password, salt) {
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
                return window.crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
            },
            async encrypt(data, key) {
                const enc = new TextEncoder();
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encoded = enc.encode(JSON.stringify(data));
                const ciphertext = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, encoded);
                return { iv: Array.from(iv), data: Array.from(new Uint8Array(ciphertext)) };
            },
            async decrypt(obj, key) {
                const iv = new Uint8Array(obj.iv);
                const data = new Uint8Array(obj.data);
                const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
                const dec = new TextDecoder();
                return JSON.parse(dec.decode(decrypted));
            }
        };

        /* --- ATMOSPHERE MODULE (C: SINFON√çA NOCTURNA) --- */
        const AudioSys = {
            ctx: null, osc: null, gain: null, playing: false,
            init() {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                this.gain = this.ctx.createGain();
                this.gain.gain.value = 0.15;
                this.gain.connect(this.ctx.destination);
                this.osc = this.ctx.createOscillator();
                this.osc.type = 'triangle';
                this.osc.frequency.setValueAtTime(55, this.ctx.currentTime);
                this.osc.connect(this.gain);
                this.osc.start();
                this.ctx.suspend();
            },
            toggle() {
                if(!this.ctx) this.init();
                if(this.ctx.state === 'suspended') { 
                    this.ctx.resume(); this.playing = true; 
                    document.getElementById('audioBtn').innerHTML = 'üîä';
                    document.getElementById('audioBtn').classList.add('shadow-[0_0_15px_#dc143c]');
                } else { 
                    this.ctx.suspend(); this.playing = false; 
                    document.getElementById('audioBtn').innerHTML = 'üîá';
                    document.getElementById('audioBtn').classList.remove('shadow-[0_0_15px_#dc143c]');
                }
            }
        };

        /* --- PARTICLES MODULE (C) --- */
        const Particles = {
            canvas: null, ctx: null, particles: [],
            init() {
                this.canvas = document.getElementById('particlesCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                for(let i=0; i<50; i++) this.particles.push(this.createParticle());
                this.animate();
            },
            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
            createParticle() { return { x: Math.random()*this.canvas.width, y: Math.random()*this.canvas.height, size: Math.random()*2, speedY: Math.random()*0.5 + 0.1, opacity: Math.random()*0.5 }; },
            animate() {
                this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
                this.particles.forEach(p => {
                    p.y -= p.speedY;
                    if(p.y < 0) p.y = this.canvas.height;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                    this.ctx.fillStyle = (document.documentElement.getAttribute('data-theme') === 'red' ? 'rgba(220, 20, 60, ' : (document.documentElement.getAttribute('data-theme') === 'green' ? 'rgba(16, 185, 129, ' : 'rgba(51, 102, 255, ')) + p.opacity + ')';
                    this.ctx.fill();
                });
                requestAnimationFrame(() => this.animate());
            }
        };

        /* --- VAULT LOGIC --- */
        async function unlockVault() {
            const pwd = document.getElementById('vaultPassword').value;
            if(!pwd) return alert("El sello requiere una llave.");
            let salt = localStorage.getItem('gothicSalt');
            let isNew = false;
            if(!salt) {
                const saltArr = window.crypto.getRandomValues(new Uint8Array(16));
                salt = JSON.stringify(Array.from(saltArr));
                localStorage.setItem('gothicSalt', salt);
                isNew = true;
            }
            try {
                const s = new Uint8Array(JSON.parse(salt));
                vaultKey = await Crypto.deriveKey(pwd, s);
                if(!db) await initDB();
                document.getElementById('lockScreen').classList.add('unlocked');
                document.getElementById('mainApp').classList.remove('hidden');
                setTimeout(() => document.getElementById('lockScreen').style.display='none', 1000);
                Particles.init();
                if(isNew) showGothicToast("Sello Creado. No olvides tu contrase√±a.");
                else showGothicToast("Sello Roto. Acceso concedido.");
                loadGallery();
            } catch(e) { console.error(e); alert("La llave es incorrecta o el sello est√° roto."); }
        }

        window.lockVault = () => {
            vaultKey = null; 
            dbEncrypted = true;
            document.getElementById('mainApp').classList.add('hidden');
            const lock = document.getElementById('lockScreen');
            lock.style.display = 'flex';
            setTimeout(() => lock.classList.remove('unlocked'), 10);
            document.getElementById('galleryContainer').innerHTML = '';
            if(AudioSys.ctx && AudioSys.playing) AudioSys.toggle();
            showGothicToast("B√≥veda Sellada. Llave destruida.");
        };

        /* --- EDITOR MODULE (B: TALLER DEL ALQUIMISTA) --- */
        const Editor = {
            canvas: null, ctx: null, img: null, rotation: 0,
            open(base64) {
                const modal = document.getElementById('editorModal');
                this.canvas = document.getElementById('editorCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.img = new Image();
                this.img.onload = () => { this.reset(); modal.classList.remove('hidden'); };
                this.img.src = base64;
                editorOriginalImage = base64; 
            },
            reset() {
                this.rotation = 0;
                this.canvas.width = this.img.width;
                this.canvas.height = this.img.height;
                this.ctx.drawImage(this.img, 0, 0);
            },
            apply(action) {
                if(action === 'reset') { this.reset(); return; }
                const w = this.canvas.width; const h = this.canvas.height;
                const temp = document.createElement('canvas'); temp.width=w; temp.height=h;
                const tCtx = temp.getContext('2d'); tCtx.drawImage(this.canvas,0,0);
                this.ctx.clearRect(0,0,w,h);
                this.ctx.save();
                if(action === 'rotate') {
                    this.rotation = (this.rotation + 90) % 360;
                    if(this.rotation % 180 !== 0) { this.canvas.width = this.img.height; this.canvas.height = this.img.width; } 
                    else { this.canvas.width = this.img.width; this.canvas.height = this.img.height; }
                    this.ctx.translate(this.canvas.width/2, this.canvas.height/2);
                    this.ctx.rotate(this.rotation * Math.PI/180);
                    this.ctx.drawImage(this.img, -this.img.width/2, -this.img.height/2);
                } else {
                    this.ctx.drawImage(temp, 0, 0);
                    if(action === 'grayscale') this.ctx.filter = 'grayscale(100%)';
                    if(action === 'sepia') this.ctx.filter = 'sepia(100%)';
                    if(action === 'invert') this.ctx.filter = 'invert(100%)';
                    this.ctx.drawImage(this.canvas, 0, 0);
                    this.ctx.filter = 'none';
                }
                this.ctx.restore();
            },
            save() {
                tempCompressedImage = this.canvas.toDataURL('image/jpeg', 0.8);
                updateImagePreview(); 
                document.getElementById('fileNameDisplay').innerText = "Imagen Transmutada";
                document.getElementById('editorModal').classList.add('hidden');
            }
        };
        window.editorAction = (a) => Editor.apply(a);
        window.saveEditor = () => Editor.save();
        window.closeEditor = () => document.getElementById('editorModal').classList.add('hidden');
        window.toggleAudio = () => AudioSys.toggle();

        /* --- CORE LOGIC --- */
        function initDB() { return new Promise((resolve, reject) => { const r = indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded = (e) => { const d = e.target.result; if (!d.objectStoreNames.contains(STORE_NAME)) d.createObjectStore(STORE_NAME, { keyPath: 'id' }); }; r.onsuccess = (e) => { db = e.target.result; setupDragDrop(); setInterval(autoSaveForm, 10000); resolve(); }; r.onerror = reject; }); }
        
        window.handleFile = (files) => {
            const file = files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => Editor.open(e.target.result);
            reader.readAsDataURL(file);
        };

        window.addItem = async () => {
            if(!vaultKey) return alert("B√≥veda cerrada.");
            const cat = document.getElementById('inputCategory').value.trim();
            const desc = document.getElementById('inputDescription').value.trim();
            const tags = document.getElementById('inputTags').value.trim().split(',').map(t=>t.trim()).filter(t=>t);
            const isEditing = editingItemId !== null;
            if (!desc) { showGothicToast("Falta T√≠tulo.", 'error'); return; }
            document.getElementById('globalLoader').classList.remove('hidden');

            let finalImage = tempCompressedImage; 
            if(!finalImage && imageSource === 'url') finalImage = document.getElementById('inputImageUrl').value;
            if(!finalImage && isEditing) finalImage = document.getElementById('editItemId').dataset.currentImage;
            
            const plainItem = {
                id: isEditing ? editingItemId : Date.now(),
                category: cat, description: desc, tags: tags, imageData: finalImage || '',
                timestamp: isEditing ? parseInt(document.getElementById('editItemId').dataset.timestamp) : Date.now(),
                isFavorite: isEditing && document.getElementById('editItemId').dataset.favorite === 'true'
            };

            try {
                const encryptedData = await Crypto.encrypt(plainItem, vaultKey);
                const dbItem = { id: plainItem.id, payload: encryptedData };
                const t = db.transaction([STORE_NAME], 'readwrite');
                t.objectStore(STORE_NAME).put(dbItem);
                t.oncomplete = () => {
                    document.getElementById('globalLoader').classList.add('hidden');
                    showGothicToast("Artefacto Cifrado y Guardado.");
                    resetForm(); loadGallery();
                };
            } catch(e) { console.error(e); document.getElementById('globalLoader').classList.add('hidden'); showGothicToast("Error de Cifrado.", 'error'); }
        };

        // --- OPTIMIZACI√ìN DE CARGA (BATCH DECRYPTION CON TOLERANCIA A FALLOS V10.5) ---
        window.loadGallery = () => {
            if(!vaultKey || !db) return;
            const t = db.transaction([STORE_NAME], 'readonly');
            const s = t.objectStore(STORE_NAME);
            
            s.getAll().onsuccess = (e) => {
                const rawItems = e.target.result;
                updateCryptSize(rawItems);
                const container = document.getElementById('galleryContainer');
                container.innerHTML = '';
                if (currentLayout === 'grid') container.className = 'columns-1 md:columns-2 lg:columns-3 xl:columns-4 gap-6 space-y-6';
                else container.className = 'grid grid-cols-1 gap-4';

                if (rawItems.length === 0) { container.innerHTML = '<div class="p-10 text-center text-gothic-accent">Vac√≠o...</div>'; return; }

                const decryptedBatch = [];
                const batchSize = 10;
                
                showGothicToast("Descifrando...");

                const processBatch = async (index) => {
                    if (index >= rawItems.length) { finishRendering(decryptedBatch); return; }
                    const end = Math.min(index + batchSize, rawItems.length);
                    for (let i = index; i < end; i++) {
                        try {
                            if (rawItems[i].payload) {
                                const item = await Crypto.decrypt(rawItems[i].payload, vaultKey);
                                decryptedBatch.push(item);
                            }
                        } catch (err) { 
                            console.error(`ERROR (V10.5): Falla al descifrar el artefacto ID ${rawItems[i].id}. Se est√° saltando.`, err); 
                            // FALLBACK SEGURO: Inyectar un objeto que no rompa el render
                            decryptedBatch.push({
                                id: rawItems[i].id,
                                description: "¬°ARTEFACTO CORRUPTO!",
                                category: "ERROR CR√çTICO",
                                tags: ["#CORRUPTO"],
                                imageData: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='red' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z'/></svg>" 
                            });
                            showGothicToast("Un artefacto fall√≥ el descifrado y fue omitido.", 'error');
                        }
                    }
                    setTimeout(() => processBatch(end), 0);
                };
                processBatch(0);
                
                function finishRendering(items) {
                    const search = document.getElementById('searchInput').value.toLowerCase();
                    const filter = document.getElementById('filterField').value;
                    if (search || filter === 'favorites') {
                        items = items.filter(i => {
                            const inDesc = (i.description||'').toLowerCase().includes(search);
                            const inCat = (i.category||'').toLowerCase().includes(search);
                            const inTags = (i.tags||[]).some(t => t.toLowerCase().includes(search));
                            if (filter === 'favorites') return i.isFavorite && (inDesc || inCat || inTags);
                            if (filter === 'description') return inDesc;
                            if (filter === 'category') return inCat;
                            if (filter === 'tags') return inTags;
                            return inDesc || inCat || inTags;
                        });
                    }
                    const sort = document.getElementById('sortSelect').value;
                    items.sort((a,b) => {
                       if(sort==='title_asc') return (a.description||'').localeCompare(b.description||'');
                       if(sort==='title_desc') return (b.description||'').localeCompare(a.description||'');
                       if(sort==='timestamp_asc') return a.timestamp - b.timestamp;
                       return b.timestamp - a.pathname - a.timestamp;
                    });
                    currentFilteredItems = items; currentPage = 1; renderGalleryHTML(currentFilteredItems);
                    showGothicToast("Cripta Abierta.");
                }
            };
        };

        function updateCryptSize(items) { let totalBytes = 0; if (items && items.length > 0) totalBytes = new Blob([JSON.stringify(items)]).size; document.getElementById('cryptSize').innerText = `Peso Cifrado: ${(totalBytes/1024).toFixed(2)} KB`; }
        function sanitizeURL(url) { if (!url) return ''; if (/^\s*(javascript|vbscript|data):/i.test(url) && !url.startsWith('data:image')) return ''; return url.replace(/"/g, '%22'); }
        function escapeHTML(str) { if (!str) return ''; return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
        window.showGothicToast = (msg, type='info') => { const container = document.getElementById('toastContainer'); const toast = document.createElement('div'); const t = themes[document.documentElement.getAttribute('data-theme')||'red']; let color = t.primary_shadow.match(/[\d.]+/g).slice(0,3).join(','); if(type==='error') color='255,0,0'; toast.className = 'gothic-toast rounded-sm relative opacity-0 transition-opacity duration-300'; toast.style.borderColor = `rgb(${color})`; toast.style.boxShadow = `0 5px 20px rgba(0,0,0,0.5), 0 0 10px rgb(${color}/0.5)`; toast.innerHTML = `<span style="color:rgb(${color});margin-right:10px;font-size:1.2em;">‚ú†</span> ${escapeHTML(msg)}`; container.prepend(toast); setTimeout(()=>toast.style.opacity='1',10); setTimeout(()=>toast.style.opacity='0',4500); setTimeout(()=>toast.remove(),5000); };
        window.handleUrlInput = (el) => { currentImageFile = null; tempCompressedImage=null; updateImagePreview(); }; 
        function updateImagePreview() { const p = document.getElementById('previewImage'); let url = tempCompressedImage || document.getElementById('inputImageUrl').value; if(url) { p.innerHTML=''; p.style.backgroundImage = `url('${sanitizeURL(url)}')`; } else { p.style.backgroundImage='none'; p.innerHTML='VAC√çO'; } }
        function updatePreviewText() { document.getElementById('previewCategory').innerText = document.getElementById('inputCategory').value || 'Clasificaci√≥n'; document.getElementById('previewDescription').innerText = document.getElementById('inputDescription').value || 'T√≠tulo'; const tContainer = document.getElementById('previewTags'); tContainer.innerHTML = ''; document.getElementById('inputTags').value.split(',').forEach(t => { if(t.trim()){ const s = document.createElement('span'); s.className = 'text-[10px] bg-black/60 border border-gothic-accent/40 px-2 py-1 rounded text-gothic-gold/80'; s.textContent = t.trim(); tContainer.appendChild(s); } }); }
        window.resetForm = () => { document.getElementById('inputDescription').value=''; document.getElementById('inputCategory').value=''; document.getElementById('inputTags').value=''; editingItemId=null; currentImageFile=null; tempCompressedImage=null; updateImagePreview(); updatePreviewText(); document.getElementById('actionButton').innerText="Consagrar (Cifrar)"; document.getElementById('cancelEditBtn').classList.add('hidden'); document.getElementById('formTitle').innerText="Nuevo Artefacto"; };
        window.selectSource = (s) => { imageSource=s; document.getElementById('tabFile').className = s==='file'?'gothic-tab-active font-heading uppercase tracking-widest text-gothic-primary pb-2 px-4 border-b-2 border-gothic-primary transition-colors':'text-sm font-heading text-gray-500 hover:text-gothic-primary pb-2 px-4 transition-colors'; document.getElementById('tabUrl').className = s==='url'?'gothic-tab-active font-heading uppercase tracking-widest text-gothic-primary pb-2 px-4 border-b-2 border-gothic-primary transition-colors':'text-sm font-heading text-gray-500 hover:text-gothic-primary pb-2 px-4 transition-colors'; document.getElementById('contentFile').classList.toggle('hidden', s!=='file'); document.getElementById('contentUrl').classList.toggle('hidden', s!=='url'); updateImagePreview(); }; window.cancelEdit = resetForm; window.closeConfirmModal = () => document.getElementById('confirmModal').classList.add('hidden');
        window.toggleSelectMode = () => { selectMode = !selectMode; selectedIds.clear(); document.getElementById('selectionBar').classList.toggle('hidden'); loadGallery(); }; window.toggleSelection = (id) => { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); document.getElementById('selectedCount').innerText=selectedIds.size; }; window.deleteSelected = () => { if(!confirm("¬øPurgar selecci√≥n?")) return; const t = db.transaction([STORE_NAME],'readwrite'); const s = t.objectStore(STORE_NAME); selectedIds.forEach(id=>s.delete(id)); t.oncomplete=()=>{toggleSelectMode(); loadGallery(); showGothicToast("Selecci√≥n purgada.");}; };
        window.deleteItem = (id) => db.transaction([STORE_NAME],'readwrite').objectStore(STORE_NAME).delete(id).onsuccess = () => { loadGallery(); showGothicToast("Purgado."); };
        window.toggleFavorite = async (id) => { 
            const t = db.transaction([STORE_NAME],'readwrite'); const s = t.objectStore(STORE_NAME);
            const req = s.get(id);
            req.onsuccess = async (e) => {
                const dbItem = e.target.result;
                if(dbItem && dbItem.payload) {
                    const plain = await Crypto.decrypt(dbItem.payload, vaultKey);
                    plain.isFavorite = !plain.isFavorite;
                    dbItem.payload = await Crypto.encrypt(plain, vaultKey);
                    s.put(dbItem);
                    loadGallery();
                }
            };
        };
        window.editItem = (id) => {
             const t = db.transaction([STORE_NAME], 'readonly'); const s = t.objectStore(STORE_NAME);
             s.get(id).onsuccess = async (e) => {
                 const dbItem = e.target.result;
                 const i = await Crypto.decrypt(dbItem.payload, vaultKey);
                 editingItemId = i.id; document.getElementById('formTitle').innerText = "Editar ID: " + i.id; document.getElementById('actionButton').innerText = "Actualizar (Re-cifrar)"; document.getElementById('cancelEditBtn').classList.remove('hidden'); document.getElementById('inputCategory').value = i.category || ''; document.getElementById('inputDescription').value = i.description || ''; document.getElementById('inputTags').value = (i.tags || []).join(', '); const meta = document.getElementById('editItemId'); meta.dataset.timestamp = i.timestamp; meta.dataset.currentImage = i.imageData; meta.dataset.favorite = i.isFavorite; if(i.imageData.startsWith('data:')) { selectSource('file'); currentImageFile = null; tempCompressedImage=i.imageData; document.getElementById('fileNameDisplay').innerText = "Imagen Descifrada"; } else { selectSource('url'); document.getElementById('inputImageUrl').value = i.imageData; } updatePreviewText(); updateImagePreview(); window.scrollTo({top:0,behavior:'smooth'});
             };
        };

        function renderGalleryHTML(items) { const container = document.getElementById('galleryContainer'); while (container.firstChild) container.removeChild(container.firstChild); const total = items.length; const start = (currentPage - 1) * itemsPerPage; const show = items.slice(start, start + itemsPerPage); document.getElementById('itemCount').innerText = total + " Artefactos"; if (currentLayout === 'grid') { container.className = 'columns-1 md:columns-2 lg:columns-3 xl:columns-4 gap-6 space-y-6'; } else { container.className = 'grid grid-cols-1 gap-4'; } if (total === 0) { const emptyDiv = document.createElement('div'); emptyDiv.className = 'p-10 text-center text-gothic-accent font-heading tracking-widest'; emptyDiv.textContent = 'El vac√≠o devuelve la mirada...'; container.appendChild(emptyDiv); return; } const lastId = sessionStorage.getItem(lastCreatedIdKey); show.forEach(item => { const imgUrl = sanitizeURL(item.imageData); const card = document.createElement('div'); card.onclick = () => openModal(item.id); card.ondblclick = () => editItem(item.id); if (currentLayout === 'grid') { card.className = "masonry-item gothic-panel rounded-sm overflow-hidden relative group cursor-pointer break-inside-avoid transition-all duration-300 hover:shadow-gothic-glow"; const imgDiv = document.createElement('div'); imgDiv.className = "w-full relative"; const img = document.createElement('img'); img.src = imgUrl; img.className = "w-full h-auto block"; img.loading = "lazy"; imgDiv.appendChild(img); const actions = document.createElement('div'); actions.className = "absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2"; const delBtn = document.createElement('button'); delBtn.className = "bg-black/80 text-gothic-primary p-2 rounded-full border border-gothic-primary hover:bg-gothic-primary hover:text-white transition-colors shadow-lg"; delBtn.textContent = "üóë"; delBtn.onclick = (e) => { e.stopPropagation(); showGothicConfirm('delete_item', item.id); }; actions.appendChild(delBtn); imgDiv.appendChild(actions); card.appendChild(imgDiv); const info = document.createElement('div'); info.className = "p-4 bg-gradient-to-b from-gothic-panel to-black"; const cat = document.createElement('div'); cat.className = "text-[10px] text-gothic-gold font-bold uppercase tracking-widest mb-1"; cat.textContent = item.category || 'SIN CLASIFICAR'; const title = document.createElement('h3'); title.className = "text-lg text-gothic-text font-heading leading-tight mb-3"; title.textContent = item.description; const tagsDiv = document.createElement('div'); tagsDiv.className = "flex flex-wrap gap-1 mt-2 pt-2 border-t border-gothic-accent/20"; (item.tags || []).forEach(t => { const tag = document.createElement('span'); tag.className = "text-[9px] bg-gothic-accent/10 border border-gothic-accent/30 px-2 py-0.5 rounded text-gothic-text/70"; tag.textContent = t; tagsDiv.appendChild(tag); }); info.append(cat, title, tagsDiv); card.appendChild(info); } else { card.className = "gothic-panel rounded-sm relative group cursor-pointer flex items-center p-3 transition-all hover:scale-[1.005] hover:border-gothic-primary/50"; const thumb = document.createElement('div'); thumb.className = "w-16 h-16 bg-cover bg-center mr-4 border border-gothic-accent flex-shrink-0"; thumb.style.backgroundImage = `url('${imgUrl}')`; card.appendChild(thumb); const textDiv = document.createElement('div'); textDiv.className = "flex-grow min-w-0"; const h3 = document.createElement('h3'); h3.className = "text-gothic-text font-heading text-lg truncate"; h3.textContent = item.description; const p = document.createElement('p'); p.className = "text-xs text-gothic-gold uppercase tracking-wider"; p.textContent = item.category; textDiv.append(h3, p); card.appendChild(textDiv); const delBtnList = document.createElement('button'); delBtnList.className = "ml-4 text-gothic-accent hover:text-red-500 transition-colors p-2 opacity-0 group-hover:opacity-100"; delBtnList.textContent = "üóë"; delBtnList.onclick = (e) => { e.stopPropagation(); showGothicConfirm('delete_item', item.id); }; card.appendChild(delBtnList); } const fav = document.createElement('button'); fav.className = `absolute bottom-2 right-2 z-20 transition-transform hover:scale-110 ${item.isFavorite ? 'text-yellow-500 drop-shadow-[0_0_5px_rgba(255,215,0,0.5)]' : 'text-gray-600 hover:text-yellow-500'}`; fav.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'; fav.onclick = (e) => { e.stopPropagation(); toggleFavorite(item.id); }; card.appendChild(fav); if (selectMode) { const checkContainer = document.createElement('div'); checkContainer.className = "absolute top-2 left-2 z-50 p-1 bg-black/50 rounded"; checkContainer.onclick = (e) => e.stopPropagation(); const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'select-checkbox block'; chk.checked = selectedIds.has(item.id); chk.onchange = () => toggleSelection(item.id); checkContainer.appendChild(chk); card.appendChild(checkContainer); } container.appendChild(card); }); updatePaginationControls(total); }
        function updatePaginationControls(total) { const totalPages = Math.ceil(total / itemsPerPage); const prevBtn = document.getElementById('prevPageBtn'); const nextBtn = document.getElementById('nextPageBtn'); const pageInfo = document.getElementById('pageInfo'); const controls = document.getElementById('paginationControls'); pageInfo.innerText = `P√°gina ${currentPage} de ${totalPages || 1}`; prevBtn.disabled = (currentPage === 1) || (total === 0); nextBtn.disabled = (currentPage === totalPages) || (total === 0); if (totalPages <= 1) controls.classList.add('hidden'); else controls.classList.remove('hidden'); }
        function changePage(d) { currentPage+=d; loadGallery(); window.scrollTo({top:0, behavior:'smooth'}); }
        window.openModal = (id) => { db.transaction([STORE_NAME]).objectStore(STORE_NAME).get(id).onsuccess = async (e) => { const dbItem = e.target.result; const i = await Crypto.decrypt(dbItem.payload, vaultKey); document.getElementById('modalImg').src = sanitizeURL(i.imageData); document.getElementById('modalTitle').innerText = i.description; document.getElementById('modalCategory').innerText = i.category; const tc = document.getElementById('modalTags'); tc.innerHTML=''; (i.tags||[]).forEach(t=>{const s=document.createElement('span'); s.className='text-xs bg-gothic-primary/20 px-2 rounded border border-gothic-primary/50 text-gothic-text'; s.textContent=t; tc.appendChild(s); }); document.getElementById('imageModal').classList.remove('hidden'); document.getElementById('modalDownload').href = i.imageData; }; };

        // --- P2P SYNC LOGIC ---
        let pc, dataChannel, syncRole = 'host'; const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        
        function resetSyncModalUI() {
            document.getElementById('localOffer').value = '';
            document.getElementById('remoteAnswer').value = '';
            document.getElementById('syncStatus').classList.add('hidden');
            document.getElementById('syncProgress').classList.add('hidden');
            document.getElementById('step2').classList.remove('active-step');
            
            document.getElementById('btnHost').className = "flex-1 py-2 text-gothic-primary border-b-2 border-gothic-primary bg-gothic-accent/10 font-bold uppercase tracking-wider";
            document.getElementById('btnGuest').className = "flex-1 py-2 text-gothic-text font-bold uppercase tracking-wider";
        }

        window.toggleSyncModal = () => { 
            const m = document.getElementById('syncModal'); 
            if (m.classList.contains('hidden')) { 
                m.classList.remove('hidden'); 
                resetSyncModalUI();
                setSyncRole('host'); 
            } else { 
                m.classList.add('hidden'); 
                cancelSync(false);
            } 
        };

        window.cancelSync = (showToast = true) => {
            if (pc) pc.close(); 
            pc = null;
            resetSyncModalUI();
            if (showToast) showGothicToast("V√≠nculo WebRTC Cancelado.");
        };

        window.setSyncRole = (r) => { 
            syncRole = r; 
            cancelSync(false);
            
            const btnHost = document.getElementById('btnHost');
            const btnGuest = document.getElementById('btnGuest');
            
            if (r === 'host') {
                btnHost.className = "flex-1 py-2 text-gothic-primary border-b-2 border-gothic-primary bg-gothic-accent/10 font-bold uppercase tracking-wider";
                btnGuest.className = "flex-1 py-2 text-gray-500 hover:text-gothic-text font-bold uppercase tracking-wider";
                initHost();
            } else {
                btnGuest.className = "flex-1 py-2 text-gothic-primary border-b-2 border-gothic-primary bg-gothic-accent/10 font-bold uppercase tracking-wider";
                btnHost.className = "flex-1 py-2 text-gray-500 hover:text-gothic-text font-bold uppercase tracking-wider";
                initGuest();
                document.getElementById('step2').classList.add('active-step'); 
            }
        };
        
        async function initHost() { 
            if(pc) pc.close(); pc = new RTCPeerConnection(rtcConfig); 
            pc.onicecandidate = e => { 
                if(!e.candidate) { 
                    document.getElementById('localOffer').value = btoa(JSON.stringify(pc.localDescription)); 
                    document.getElementById('step2').classList.add('active-step'); 
                }
            }; 
            dataChannel = pc.createDataChannel("g"); 
            setupDC(dataChannel); 
            const o = await pc.createOffer(); 
            await pc.setLocalDescription(o); 
            document.getElementById('localOffer').placeholder = "Copia este c√≥digo y env√≠alo al Destino...";
        }
        
        function initGuest() { 
            if(pc) pc.close(); pc = new RTCPeerConnection(rtcConfig); 
            pc.ondatachannel = e => { dataChannel = e.channel; setupDC(dataChannel); }; 
            document.getElementById('localOffer').placeholder = "Pega aqu√≠ el c√≥digo del Origen primero...";
        }
        
        function setupDC(dc) { 
            dc.onopen = () => { 
                document.getElementById('syncStatus').classList.remove('hidden'); 
                document.getElementById('hostActions').classList.toggle('hidden', syncRole !== 'host'); 
                document.getElementById('guestActions').classList.toggle('hidden', syncRole !== 'guest'); 
            }; 
            dc.onmessage = handleDataMessage; 
        }

        window.finishHandshake = async () => { 
            const r = document.getElementById('remoteAnswer').value; 
            if(!r) return showGothicToast("Pega el c√≥digo remoto.", 'error'); 
            try{ 
                const d = JSON.parse(atob(r)); 
                await pc.setRemoteDescription(d); 
                if(syncRole==='guest'){ 
                    const a = await pc.createAnswer(); 
                    await pc.setLocalDescription(a); 
                    document.getElementById('localOffer').value = btoa(JSON.stringify(pc.localDescription));
                }
            } catch(e){ 
                showGothicToast("C√≥digo corrupto o inv√°lido.", 'error'); 
            }
        };

        window.copyToClipboard = (id) => { navigator.clipboard.writeText(document.getElementById(id).value); showGothicToast("Copiado."); };
        
        async function startDataSync() {
            const t = db.transaction([STORE_NAME], 'readonly');
            const encryptedItems = await new Promise((res) => { t.objectStore(STORE_NAME).getAll().onsuccess = (e) => res(e.target.result); });
            if (encryptedItems.length === 0) return showGothicToast("Nada que enviar.");
            showGothicToast(`Descifrando y transmitiendo ${encryptedItems.length} artefactos...`);
            document.getElementById('syncProgress').classList.remove('hidden');
            const bar = document.getElementById('syncBar');

            dataChannel.send(JSON.stringify({ type: 'START', total: encryptedItems.length }));
            let i = 0;
            const streamInterval = setInterval(async () => {
                if (i >= encryptedItems.length) { clearInterval(streamInterval); dataChannel.send(JSON.stringify({ type: 'END' })); return; }
                if (dataChannel.bufferedAmount > 1024 * 1024) return;
                
                try {
                    const plainItem = await Crypto.decrypt(encryptedItems[i].payload, vaultKey);
                    dataChannel.send(JSON.stringify({ type: 'ITEM', data: plainItem }));
                    i++;
                    const pct = Math.round((i / encryptedItems.length) * 100);
                    bar.style.width = pct + '%';
                } catch(e) { console.error("Skip corrupt item"); i++; }
            }, 50);
        }

        async function handleDataMessage(e) {
            const msg = JSON.parse(e.data);
            const bar = document.getElementById('syncBar');
            document.getElementById('syncProgress').classList.remove('hidden');
            if (msg.type === 'START') { showGothicToast(`Recibiendo ${msg.total} artefactos...`); } 
            else if (msg.type === 'ITEM') {
                const plainItem = msg.data;
                const encData = await Crypto.encrypt(plainItem, vaultKey);
                const dbItem = { id: plainItem.id, payload: encData };
                const t = db.transaction([STORE_NAME], 'readwrite');
                t.objectStore(STORE_NAME).put(dbItem);
                bar.style.width = '50%';
            } 
            else if (msg.type === 'END') { bar.style.width = '100%'; showGothicToast("Sincronizaci√≥n completada."); loadGallery(); setTimeout(toggleSyncModal, 2000); }
        }

        // INIT
        window.onload = async () => { if (localStorage.getItem('gothicSalt')) await initDB(); };
    </script>
</body>
</html>
